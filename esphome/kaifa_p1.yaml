# Wiring for Kaifa MA110M P1 -> Wemos D1 mini (ESP8266)
#
# RJ12 (6P6C) plug orientation: clip down, contacts toward you, pins numbered 1..6 from left to right.
#
# P1 pin 1 (+5V power, from meter):
#   - Connect to Wemos 5V (or VIN) pin to power the board.
#   - Also connect P1 pin 1 to P1 pin 2 through a 1 kΩ resistor (Request pull-up).
#
# P1 pin 2 (Request input, to meter):
#   - Connect ONLY via 1 kΩ resistor to P1 pin 1.
#   - Do NOT connect directly to any ESP8266 pin.
#
# P1 pin 3 (Data GND):
#   - Connect to Wemos GND (together with pin 6).
#
# P1 pin 4 (N.C.):
#   - Not connected.
#
# P1 pin 5 (Data output, open collector / optocoupler):
#   - Connect directly to Wemos RX pin (GPIO3).
#   - Additionally, connect Wemos 3V3 to the same RX node through a 680–1000 Ω resistor
#     (for example 820 Ω). This resistor provides the required 5–6 mA current for the
#     P1 optocoupler while keeping the RX voltage within 3.3 V.
#
# P1 pin 6 (Power GND):
#   - Connect to Wemos GND (can be tied together with pin 3).

esphome:
  name: electricity-meter
  friendly_name: Electricity meter

esp8266:
  board: d1_mini

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  power_save_mode: LIGHT
  output_power: 8.5dBm
  ap:
    ssid: "Electricity-Meter"
    password: "REPLACE_WITH_YOUR_CUSTOM_AP_PASSWORD"
  # Optional: set minimum auth mode explicitly
  min_auth_mode: WPA2

api:
  encryption:
    key: "REPLACE_WITH_YOUR_API_KEY"

ota:
  - platform: esphome
    password: "REPLACE_WITH_YOUR_OTA_PASSWORD"

logger:
  level: DEBUG
  baud_rate: 0  # disable UART logging, we use UART0 for P1

uart:
  id: p1_uart
  rx_pin:
    number: GPIO3       # RX0 on Wemos D1 mini
    inverted: true      # Kaifa DSMR 5.0 P1 uses inverted UART
  baud_rate: 115200
  data_bits: 8
  parity: NONE
  stop_bits: 1
  rx_buffer_size: 1700  # big enough for a full telegram

# DSMR parser for the P1 telegrams
dsmr:
  uart_id: p1_uart
  crc_check: true
  max_telegram_length: 1500

sensor:
  # Imported energy (from grid to you), Kaifa uses 1.8.11 / 12 / 13 for T1/T2/T3
  - platform: dsmr
    energy_delivered_tariff1:
      name: "Kaifa Energy T1"
      id: kaifa_energy_t1
      state_class: total_increasing
    energy_delivered_tariff2:
      name: "Kaifa Energy T2"
      id: kaifa_energy_t2
      state_class: total_increasing
    energy_delivered_tariff3:
      name: "Kaifa Energy T3"
      id: kaifa_energy_t3
      state_class: total_increasing

    # Exported energy (from you to grid), if ever used
    energy_returned_tariff1:
      name: "Kaifa Export T1"
      id: kaifa_export_t1
      state_class: total_increasing
    energy_returned_tariff2:
      name: "Kaifa Export T2"
      id: kaifa_export_t2
      state_class: total_increasing
    energy_returned_tariff3:
      name: "Kaifa Export T3"
      id: kaifa_export_t3
      state_class: total_increasing

    power_delivered:
      name: "Kaifa Power Now"
    power_returned:
      name: "Kaifa Power Export"

    voltage_l1:
      name: "Kaifa Voltage L1"
    current_l1:
      name: "Kaifa Current L1"

  # Total imported energy: T1 + T2 + T3
  - platform: template
    name: "Kaifa Energy Total"
    id: kaifa_energy_total
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    lambda: |-
      if (isnan(id(kaifa_energy_t1).state) ||
          isnan(id(kaifa_energy_t2).state) ||
          isnan(id(kaifa_energy_t3).state)) {
        return NAN;
      }
      return id(kaifa_energy_t1).state +
             id(kaifa_energy_t2).state +
             id(kaifa_energy_t3).state;

  # Total exported energy: T1 + T2 + T3
  - platform: template
    name: "Kaifa Export Total"
    id: kaifa_export_total
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    lambda: |-
      if (isnan(id(kaifa_export_t1).state) ||
          isnan(id(kaifa_export_t2).state) ||
          isnan(id(kaifa_export_t3).state)) {
        return NAN;
      }
      return id(kaifa_export_t1).state +
             id(kaifa_export_t2).state +
             id(kaifa_export_t3).state;

text_sensor:
  - platform: dsmr
    identification:
      name: "Kaifa Meter ID"
    p1_version:
      name: "Kaifa DSMR Version"

# Optional heartbeat LED on the Wemos (commented by default).
# Uncomment this block if you want a blinking LED.
#
# output:
#   - platform: gpio
#     pin:
#       number: GPIO2      # onboard LED (D4)
#       inverted: true
#     id: led_builtin
#
# light:
#   - platform: binary
#     id: status_led
#     name: "Electricity Meter LED"
#     output: led_builtin
#
# interval:
#   - interval: 1s
#     then:
#       - light.toggle: status_led
